# Server Monitoring Guide

This comprehensive guide covers the installation, configuration, and usage of monitoring tools for your VPS. Proper monitoring enables early detection of security threats, performance issues, and system anomalies.

## 1. Grafana Installation and Configuration

Grafana provides powerful visualization capabilities for system metrics and security events. The installation process establishes the monitoring foundation.

```bash
sudo apt install -y grafana
sudo systemctl enable grafana-server
sudo systemctl start grafana-server
```

After installation, verify the service is running correctly.

```bash
sudo systemctl status grafana-server
```

Access the Grafana web interface at `http://your-server-ip:3000`. The default credentials are username `admin` and password `admin`. Change these immediately upon first login.

### Initial Configuration

Configure Grafana's administrative settings for enhanced security. Edit the configuration file to set custom admin credentials and disable anonymous access.

```bash
sudo nano /etc/grafana/grafana.ini
```

Locate the `[security]` section and modify these settings:
- admin_user: Set a unique administrator username
- admin_password: Use a strong, complex password generated by your password manager
- disable_initial_admin_creation: Set to false for first setup, then true after creation

Restart Grafana to apply configuration changes.

```bash
sudo systemctl restart grafana-server
```

## 2. Prometheus Installation and Setup

Prometheus collects and stores time-series metrics from configured targets. It serves as the data backend for Grafana dashboards.

```bash
sudo apt install prometheus prometheus-node-exporter
sudo systemctl enable prometheus
sudo systemctl start prometheus
```

### Prometheus Configuration

Create or modify the Prometheus configuration file to define scrape targets and intervals.

```bash
sudo nano /etc/prometheus/prometheus.yml
```

Configure the following scrape jobs:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'vps-monitor'

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node'
    static_configs:
      - targets: ['localhost:9100']
```

Reload Prometheus configuration without restarting the service.

```bash
sudo systemctl reload prometheus
```

Verify Prometheus is collecting metrics by accessing the web interface at `http://your-server-ip:9090` and checking the Targets page.

## 3. Node Exporter Configuration

Node Exporter exposes hardware and kernel metrics from the operating system. It provides essential data for system monitoring dashboards.

The node exporter typically runs on port 9100 and requires minimal configuration. Verify it's running and collecting metrics.

```bash
sudo systemctl status prometheus-node-exporter
curl http://localhost:9100/metrics
```

## 4. Grafana Data Source Setup

Connect Grafana to Prometheus to enable metric visualization. This can be done through the web interface or via provisioning files.

### Web Interface Method

Navigate to Configuration > Data Sources in Grafana. Click "Add data source" and select Prometheus. Configure these settings:
- Name: Prometheus
- URL: http://localhost:9090
- Access: Server (default)

Click "Save & Test" to verify the connection.

### Provisioning File Method

Create a provisioning file for automated data source configuration.

```bash
sudo mkdir -p /etc/grafana/provisioning/datasources
sudo nano /etc/grafana/provisioning/datasources/prometheus.yml
```

Add this configuration:

```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://localhost:9090
    isDefault: true
    editable: true
```

Restart Grafana to load the provisioned data source.

```bash
sudo systemctl restart grafana-server
```

## 5. Dashboard Creation and Import

Grafana dashboards visualize your server metrics in customizable panels. You can create custom dashboards or import pre-built ones from the Grafana community.

### Key Metrics to Monitor

Essential system metrics include CPU usage showing processor load across all cores, memory utilization tracking RAM consumption and available space, disk space monitoring to prevent capacity issues, and network traffic measuring inbound and outbound bandwidth. Additionally, monitor disk I/O operations per second, system load averages over 1, 5, and 15 minute intervals, active network connections by state, and process counts.

### Creating Custom Dashboards

Navigate to Create > Dashboard in Grafana. Add panels for each metric category using the Prometheus data source. Configure panel queries using PromQL syntax.

Example CPU usage query:
```
100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

Example memory usage query:
```
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
```

Example disk space query:
```
100 - ((node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100)
```

### Importing Pre-Built Dashboards

The Grafana community provides numerous pre-configured dashboards. The Node Exporter Full dashboard (ID: 1860) offers comprehensive system monitoring. Import it by navigating to Create > Import, entering dashboard ID 1860, and selecting your Prometheus data source.

## 6. Alert Configuration

Grafana alerts notify administrators when metrics exceed defined thresholds. Configure alerts for critical system conditions.

### Alert Rules

Create alert rules for these critical conditions:
- CPU usage exceeding 80% for more than 5 minutes indicates potential performance issues or resource exhaustion
- Memory usage above 90% suggests possible memory leaks or insufficient RAM
- Disk space below 10% free requires immediate attention to prevent service disruption
- Unusual network traffic patterns may indicate security breaches or DDoS attacks
- Service downtime detected through failed health checks

### Notification Channels

Configure notification channels to receive alerts through email, Slack, PagerDuty, or webhook integrations. Navigate to Alerting > Notification channels in Grafana to set up your preferred method.

For email notifications, configure SMTP settings in the Grafana configuration file:

```bash
sudo nano /etc/grafana/grafana.ini
```

Locate the `[smtp]` section and configure:
```
[smtp]
enabled = true
host = smtp.example.com:587
user = alerts@example.com
password = your_smtp_password
from_address = alerts@example.com
from_name = Grafana Alerts
```

## 7. Security Monitoring Integration

Integrate security-specific metrics into your monitoring system. Monitor authentication attempts, firewall blocks, and malware scan results.

### SSH Authentication Monitoring

Create alerts for failed SSH login attempts using fail2ban metrics or log analysis. This helps detect brute force attacks early.

### Firewall Activity

Monitor UFW firewall logs for blocked connection attempts. High volumes of blocked traffic may indicate reconnaissance or attack attempts.

```bash
sudo journalctl -u ufw -f
```

### Antivirus and Malware Scan Results

Parse ClamAV and rkhunter scan logs to detect malware discoveries. Integrate these into Grafana dashboards using log aggregation tools like Promtail and Loki.

## 8. Log Monitoring and Analysis

Comprehensive log monitoring provides insights into system events and security incidents. Configure centralized logging for easier analysis.

### System Logs

Monitor authentication logs for suspicious login patterns or failed access attempts.

```bash
sudo journalctl -u ssh -n 100 --no-pager
sudo tail -f /var/log/auth.log
```

### Application Logs

Web server logs reveal attack attempts, unusual traffic patterns, and application errors. Parse these logs for security-relevant events.

```bash
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/apache2/error.log
```

### Security Audit Logs

Review Lynis audit reports regularly to identify configuration weaknesses and security improvements.

```bash
sudo cat /var/log/lynis-audit-*.log | grep Warning
```

## 9. Performance Baseline Establishment

Establish normal operating baselines for your system metrics. This enables easier identification of anomalies that may indicate problems.

Monitor your system under typical load for several days to establish baseline values for CPU usage, memory consumption, disk I/O, and network traffic. Document these baselines and configure alerts with appropriate thresholds above normal ranges.

## 10. Automated Reporting

Configure automated report generation for regular security and performance reviews. Create scheduled reports that summarize key metrics, alert frequencies, and system health indicators.

### Weekly Summary Reports

Generate weekly reports showing:
- Average resource utilization across all metrics
- Number and types of security alerts triggered
- Failed authentication attempts and blocked IP addresses
- System uptime and availability percentages
- Backup completion status and sizes

### Monthly Security Audits

Compile monthly security reports including:
- Lynis audit results and score trends
- Malware scan findings from ClamAV and rkhunter
- User account changes and privilege modifications
- Software updates applied and pending
- Incident response actions taken

## 11. Dashboard Maintenance

Regular dashboard maintenance ensures monitoring remains effective as your environment evolves. Review dashboards quarterly to add new metrics, remove obsolete panels, and adjust alert thresholds based on operational experience.

Test alert notification channels periodically to verify they function correctly. Update contact information and escalation procedures as team members change.

## 12. Advanced Monitoring Considerations

For larger deployments or more complex requirements, consider implementing additional monitoring capabilities:

- Distributed tracing for application performance monitoring
- Log aggregation using ELK Stack (Elasticsearch, Logstash, Kibana) or similar
- Real-time anomaly detection using machine learning algorithms
- Synthetic monitoring for external service availability checks
- Database query performance monitoring
- Container and orchestration platform metrics if using Docker or Kubernetes

---

Effective monitoring forms a critical component of server security and reliability. Regular review of metrics, timely response to alerts, and continuous improvement of monitoring coverage ensure optimal system protection and performance.